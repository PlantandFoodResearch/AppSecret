---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

[![Travis build status](https://travis-ci.com/PlantandFoodResearch/AppSecret.svg?token=Kpqpmk91fYg5k9hdqK3y&branch=master)](https://travis-ci.com/PlantandFoodResearch/AppSecret)
[![Coverage Status](https://coveralls.io/repos/github/PlantandFoodResearch/AppSecret/badge.svg?branch=master&t=Z7xp1S)](https://coveralls.io/github/PlantandFoodResearch/AppSecret?branch=master)
[![lifecycle](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://www.tidyverse.org/lifecycle/#maturing)

```{r setup, include = FALSE}
require(here)
require(withr)
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
unlink(file.path(here::here(), '.user-settings'), recursive = TRUE)
unlink(file.path(normalizePath("~"), '.app-name'), recursive = TRUE)
```
# AppSecret

The goal of AppSecret is to manage application secrets for users, be they developers or test/production service users.

## Installation

AppSecret is not on CRAN. It is a private repository so create and expose `GITHUB_PAT` appropriately.

``` r
devtools::install_github("PlantandFoodResearch/AppSecret")
```

#### GITHUB_PAT

from `?devtools::install_github`

```
# To install from a private repo, use auth_token with a token
# from https://github.com/settings/tokens. You only need the
# repo scope. Best practice is to save your PAT in env var called
# GITHUB_PAT.
install_github("hadley/private", auth_token = "abc")
```

## Example

This is a basic example which shows you how to solve a common problem:

```{r create-a-secret}
library(here)
library(AppSecret)

password_file <- file.path(here(), ".user-settings", Sys.getenv("USER"), "password")

asm <- app_secret_manager(symmetric_file = file.path(here(), ".user-settings", Sys.getenv("USER"), "symmetric.rsa"),
                          key_file       = file.path(normalizePath("~"), ".app-name", "secret.pem"))
asm$symmetric_file
asm$key_file

encrypted <- asm$encrypt_data("this is my password")

asm$write_encrypted(data = encrypted, file = password_file)

file.exists(password_file)

asm$read_encrypted(password_file)
```

Somewhere in your application

```{r application-code}
library(here)
library(AppSecret)

password_file <- file.path(here(), ".user-settings", Sys.getenv("USER"), "password")

asm <- app_secret_manager(symmetric_file = file.path(here(), ".user-settings", Sys.getenv("USER"), "symmetric.rsa"),
                          key_file       = file.path(normalizePath("~"), ".app-name", "secret.pem"))

password <- asm$decrypt_file(password_file)
password
```

#### `app_secret_paths`

All of this path munging is not really application code's responsibility. There is a utility function `app_secret_paths` for doing this.

```{r utility-usage}
paths <- app_secret_paths(appname = "your-app-name")
str(paths)
```

The `here()` function from the `here` package can be used by adding a value to the environment variable `APP_SECRET_USE_HERE` so that files can be stored with the application code. This is safe to do as the key pair will always be stored under a user's home directory.

```{r utility-usage-with-here}
#> using withr to safely temporarily set the variable in markdown
withr::with_envvar(c("APP_SECRET_USE_HERE" = 1), {
  paths <- app_secret_paths(appname = "another-name")
  str(paths)
})
```

If the `.user-settings` path is not a desireable name the `base_path` argument may be passed.

```{r utility-usage-with-basepath}
paths <- app_secret_paths(appname = "your-app-name", base_path = here::here())
str(paths)
```

#### more simple application code

In less than 10 lines
```{r simple-application-code}
library(AppSecret)
paths <- withr::with_envvar(c("APP_SECRET_USE_HERE" = 1),
                            app_secret_paths(appname = "app-name"))
#> create instance
asm <- do.call(app_secret_manager, paths)
#> where is the password file
paths$password_file <- asm$path_in_vault("password")
#> decrypt
password <- asm$decrypt_file(paths$password_file)
password
```
